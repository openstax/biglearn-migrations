# Biglearn Migrations

## Purpose

Alembic project used for biglearn database migrations.

## Quickstart

### Installing the services

the following external services are required:

- PostgreSQL 9.4+

How you install these services is up to you, but the easiest way is by using
Docker and Docker Compose. This should work on any OS that docker can be installed on.

> NOTE: This guide assumes that you have Python 3 installed.

1. Install Docker and Docker Compose by following the instructions on the [Docker website](https://docs.docker.com/compose/install/)
2. Run Docker Compose:

    `docker-compose up`

    You will now have a container running the PostgreSQL database. If you run `docker ps` you will see the container running.
    You can connect to the PostgreSQL database by running `psql postgresql://postgres@localhost/postgres`.

    When you want to shut the container down you can interrupt the `docker-compose` command. If you would rather run them in the background, you can run `docker-compose up -d`.

3. If not running the container in daemon mode open a new terminal window.

4. Create a virtualenv and install dependencies

    `make venv`

    You will need to have python 3 installed for this to work properly.

5. Activate the virtualenv

    `source .venv/bin/activate`

6. Initialize the database:

    `make initdb`

7. Ensure the tables were created by alembic:

    `make tables`


## Running Alembic Commands

If you followed the quickstart then you should be ready to run alembic commands.

### Autogenerating migrations

The `models.py` file contains all the models that represent the tables in the tutor-server database.
The models can be changed and migration files can be autogenerated. However, not everything can be autodetected.
Visit the [alembic](http://alembic.zzzcomputing.com/en/latest/autogenerate.html#what-does-autogenerate-detect-and-what-does-it-not-detect) documentation to see what can be autogenerated.

If a change has been made run the following to create a migration file.

`alembic revision --autogenerate -m "added X column to X table"`

Review the generated file in order to make any necessary changes.

If a migration file needs to be created manually run:

`alembic revision -m "added X table to the database"`

Run the migration:

`alembic upgrade head`
